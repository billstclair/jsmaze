<html>
<head>
  <script src='js/jquery.min.js'></script>
  <script src='socket.io/socket.io.js'></script>
  <script src='server/shared/jsmaze.js'></script>
  <script src='server/shared/evalFactory.js'></script>
  <script src='js/jsClientMaze.js'></script>
  <script src='js/client.js'></script>
  <script>

function setSpines(checkbox) {
  maze.showSpines = ($(checkbox).attr('checked')=='checked');
  maze.draw3d();
}

var maze;
var canvas3d;
var canvas;

function getResource() {
  var path = window.location.pathname;
  path = path.split('/').slice(1,-1).join('/');
  return path ? path + '/socket.io' : 'socket.io';
}

function start() {
  localSetup(false, true);
  connect($('#connectButton')[0]);
}

function setCookie(c_name,value,exdays) {
  var exdate = new Date();
  exdate.setDate(exdate.getDate() + exdays);
  var c_value = escape(value) +
    (exdays ? '; expires='+exdate.toUTCString() : '');
  document.cookie = c_name + '=' + c_value;
}

function getCookie(c_name) {
  var cookies=document.cookie.split(";");
  for (var i=0;i<cookies.length;i++) {
    var cookie = cookies[i];
    var idx = cookie.indexOf('=');
    var x = cookies[i].substr(0,idx);
    var y = cookies[i].substr(idx+1);
    x = x.replace(/^\s+|\s+$/g,"");
    if (x == c_name) return unescape(y);
  }
}

function setPlayerNameCookie(playerName) {
  setCookie('playerName', playerName, 180);
}

var playerName = null;
function getPlayerName() {
  if (!playerName) playerName = getCookie('playerName');
  for (;!playerName;) {
    playerName = prompt("Enter a player nickname:", "");
    setPlayerNameCookie(playerName);
  }
  return playerName;
}

function connect(button) {
  var label = $(button).val();
  if (label == 'Connect') {
    maze.endEdit();
    maze.threeDCanvas(null);
    try {
      client.chatPromptFun = chatPrompt;
      client.connect('/', canvas3d, canvas, getResource(), getPlayerName());
      canvas3d.focus();
      $(button).val('Disconnect');
      $('#changeName').attr('disabled', null);
    } catch(err) {
      alert('Error connecting with server: ' + err);
      localSetup(true);
    }
  } else {
    try {
      client.disconnect();
    } catch(err) {
    }
    $(button).val('Connect');
    $('#changeName').attr('disabled', 'disabled');
    localSetup(true);
  }
}

function changeName() {
  var newname = prompt('New player nickname:', playerName);
  if (newname) {
    playerName = newname;
    setPlayerNameCookie(newname);
    client.changeName(newname);
  }
  canvas3d.focus();
}

function chatPrompt() {
  var msg = prompt('Say something:');
  client.chat(msg);
}

function localSetup(keepmaze, nodraw) {
// Alternating horizontal and vertical wals
  var map = ["----------",
             "||      | |",
             "  ------- ",
             "| |    | ||",
             "   -----  ",
             "|| |  | |||",
             "    ---   ",
             "||| |  ||||",
             "     -    ",
             "||||  | |||",
             "    --    ",
             "||||   | ||",
             "   ----   ",
             "||| |   | |",
             "  ------  ",
             "|| |     ||",
             " -------- ",
             "| |       |",
             "----------"]

  if (!keepmaze || !maze) maze = new jsClientMaze.ClientMaze(map);
  canvas3d = $('#draw')[0];
  canvas = $('#topview')[0];
  if (!nodraw) {
    maze.draw3d(canvas3d);
    maze.edit(canvas);
    canvas3d.focus();
  }
}
  </script>
  <title>jsMaze</title>
  <meta name='viewport' content='width=720'/>
  <style>.chatbutton { font-size: 150%; }</style>
</head>
<body onload='start();'>
  <center>
    <table>
      <tr>
        <td>
          <center>
            <canvas id='draw' width='600' height='600' tabindex='1'></canvas><br>
          </center>
        </td>
      </tr>
      <tr>
        <td>
          <center>
            <table>
              <tr>
                <td valign='top'>
                  <button type='submit' class='chatbutton' onClick='chatPrompt()'>
                    Chat
                  </button>
                </td>
                <td><canvas id='topview' width='300' height='300'></canvas></td>
                <td valign='top'>
                  <button type='submit' class='chatbutton' onClick='chatPrompt()'>
                    Chat
                  </button>
                </td>
              </tr>
            </table>
            <p>
              <input type='submit' id='connectButton' value='Connect'
                     onClick='connect(this)'/>
              <input type='checkbox' checked='checked'
                      onClick='setSpines(this)'/>
               Show Spines
              <input type='submit' id='changeName' value='Change Name'
                     onClick = 'changeName()'/>
            </p>
            <h2>jsMaze</h2>
            <p>To control with keyboard, click on 3d (upper) view.<br/>
              Controls: WASD, IJKL, arrow keys. C or "Chat" button to chat.
              Spacebar to shoot.<br>
            On touch screens, tap and hold top, bottom, left, or right
              of 3d view.<br/>
            Middle section of 3d view can be used for drag, pinch, or
              double tap.<br/>
            To change maze (disconnected only), click to toggle walls on
              lower view.</p>
            <p>Code is at <a href='https://github.com/billstclair/jsmaze'>github.com/billstclair/jsmaze</a>.<br/>
            IRC at <a href="irc://irc.freenode.net/#jsMaze">irc.freenode.net/#jsMaze</a></p>
          </center>
        </td>
      </tr>
    </table>
    <p>
  </center>
</body>
</html>
