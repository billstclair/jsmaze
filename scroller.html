<html>
<head>
  <title>Scroller Play</title>
  <script src='js/jquery.min.js'></script>
  <script>
var lines = [];
var curline = 0;                // where the next line will go
var fullp = false;
var sizes = [];
var maxlines = 10;

function addline(line) {
  lines[curline++] = line;
  if (curline >= maxlines) {
    fullp = true;
    curline = 0;
  }
  displayLines();
}

function displayLines() {
  var str = '';
  var idx = fullp ? curline : 0;
  if (idx >= maxlines) idx = 0;
  var cnt = fullp ? maxlines : curline;
  for (var i=1; i<cnt; i++) {
    str += lines[idx++];
    if (idx >= maxlines) idx = 0;
  }
  var text = $('#text');
  console.log('scrollTop:', text.scrollTop(), 'scrollHeight:', text[0].scrollHeight,
             'clientHeight:', text[0].clientHeight);
  var clientHeight = text[0].clientHeight;
  var scrollHeight = text[0].scrollHeight;
  var bottomScroll = scrollHeight - clientHeight;
  var doScroll = (text.scrollTop() == bottomScroll);
  if (!doScroll) {
    var scrollTop = text.scrollTop();
    text.html(str);
    var scrollDiff = scrollHeight - text[0].scrollHeight;
    console.log('scrollDiff:', scrollDiff);
  }
  str += lines[idx];
  text.html(str);
  if (doScroll) text.scrollTop(text[0].scrollHeight);
  else text.scrollTop(Math.max(0, scrollTop-scrollDiff));
}

function addInput() {
  var input = $('#input');
  addline(input.val()+'<br/>\n');
  input.val('');
  $
}

function onload() {
  $('#input')[0].focus();
}

function inputKey(event) {
  if (event.which == '\r'.charCodeAt(0)) {
    event.preventDefault();
    addInput();
  }
}
  </script>
</head>
<body onload='onload()'>
  <div id='text' style='width: 50em; height: 5em; overflow:auto; position:relative; border: 1px solid;'>
    <b>Text goes here</b>
  </div><br/>
  <input type='text' id='input' size='40'
         onKeyDown='inputKey(event)'/><br/>
  <input type='submit' onClick='addInput()' value='Add'/>
</body>
</html>
